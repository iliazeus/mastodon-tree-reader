<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css" />
    <title>Treeder</title>

    <script type="module">
      import * as storage from "./storage.js";
      import * as api from "./api.js";
      import * as template from "./template.js";

      window.addEventListener("load", async () => {
        storage.setUp();
        api.setUp();
        template.setUp();

        let location = new URL(window.location);

        let statusElement = document.querySelector("#status");
        let logInForm = document.querySelector("form#logIn");
        let logOutForm = document.querySelector("form#logOut");
        let loadPostForm = document.querySelector("form#loadPost");
        let postTreeContainer = document.querySelector("#postTree");
        let threadRootPrompt = document.querySelector("#threadRootPrompt");

        let formsLocked = false;
        let instanceHost = storage.getDefaultInstanceHost();
        let postUrl = location.searchParams.get("post");
        let postTree = null;

        logInForm.addEventListener("submit", (e) => {
          e.preventDefault();
          if (formsLocked) return;
          instanceHost = logInForm.elements.instanceHost.value.trim();
          try {
            instanceHost = new URL(instanceHost).host;
          } catch {}
          logIn();
        });

        logOutForm.addEventListener("submit", (e) => {
          e.preventDefault();
          if (formsLocked) return;
          logOut();
        });

        loadPostForm.addEventListener("submit", (e) => {
          e.preventDefault();
          if (formsLocked) return;
          postUrl = loadPostForm.elements.postUrl.value.trim();
          loadPost();
        });

        updateForms();
        if (postUrl) loadPost();
        return;

        async function logIn() {
          try {
            lockForms(true);
            setStatus("Logging in...");

            await api.logIn({ instanceHost });
            setStatus(null);
            updateForms();
          } catch (e) {
            setStatus(`Error logging in: ${e.message}`);
            throw e;
          } finally {
            lockForms(false);
          }
        }

        async function logOut() {
          try {
            lockForms(true);
            setStatus("Logging out...");

            postTree = null;
            renderTree();
            updateForms();

            await api.logOut({ instanceHost });
            updateForms();
            setStatus(null);
          } catch (e) {
            setStatus(`Error logging out: ${e.message}`);
            throw e;
          } finally {
            lockForms(false);
          }
        }

        async function loadPost() {
          if (!instanceHost) return setStatus(`Please log in first`);

          if (instanceHost && !api.isLoggedIn({ instanceHost }))
            return logIn({ instanceHost });

          try {
            lockForms(true);
            loadPostForm.style.display = "none";
            setStatus("Loading post...");

            let p = await api.fetchPostByUrl(postUrl, { instanceHost });
            postTree = await api.fetchPostTree(p, { instanceHost });
            setStatus(null);
            updateForms();
            renderTree();
          } catch (e) {
            setStatus(`Error loading post: ${e.message}`);
            updateForms();
            throw e;
          } finally {
            lockForms(false);
          }
        }

        function setStatus(s) {
          if (s != null) {
            statusElement.innerText = s;
            statusElement.style.display = "";
          } else {
            statusElement.innerText = "";
            statusElement.style.display = "none";
          }
        }

        function lockForms(yes) {
          formsLocked = yes;
          for (let f of [logInForm, logOutForm, loadPostForm])
            for (let s of f.querySelectorAll("input[type=submit]"))
              s.disabled = yes;
        }

        function updateForms() {
          if (instanceHost && api.isLoggedIn({ instanceHost })) {
            logOutForm.elements.instanceHost.value = instanceHost;
            logInForm.style.display = "none";
            logOutForm.style.display = "";
            loadPostForm.style.display = "";
          } else {
            logInForm.style.display = "";
            logOutForm.style.display = "none";
            loadPostForm.style.display = "none";
          }

          loadPostForm.elements.postUrl.value = postUrl ?? "";
        }

        function renderTree() {
          if (postTree != null) {
            console.log(postTree);
            template.installPostTree(postTreeContainer, postTree, {
              instanceHost,
            });
            postTreeContainer.style.display = "";
          } else {
            template.uninstallPostTree(postTreeContainer);
            postTreeContainer.style.display = "none";
          }
        }
      });
    </script>
  </head>
  <body>
    <main>
      <noscript>
        This is a web app. It won't work without JavaScript being enabled.
      </noscript>
      <form id="logIn" style="display: none">
        <label>
          Your instance URL:
          <input
            type="text"
            name="instanceHost"
            size="15"
            value="lor.sh"
            disabled
          />
        </label>
        <input type="submit" value="Log in" />
      </form>
      <form id="logOut" style="display: none">
        <label>
          Logged into:
          <input
            type="text"
            name="instanceHost"
            size="15"
            value="lor.sh"
            disabled
          />
        </label>
        <input type="submit" value="Log out" />
      </form>
      <form id="loadPost" style="display: none">
        <input type="text" name="postUrl" size="30" placeholder="Post URL" />
        <input type="submit" value="View post" />
      </form>
      <div id="status" style="display: none"></div>
      <div id="threadRootPrompt" style="display: none">
        You are viewing a subthread.
        <button>View full thread</button>
      </div>
      <div id="postTree" style="display: none"></div>
    </main>
  </body>
</html>
